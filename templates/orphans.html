{% extends "base.html" %}
{% block content %}
<h2>Chain Tips & Forks</h2>

<div class="info-box"
    style="background: #1e1e1e; border-left: 4px solid #007bff; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px; color: #e0e0e0;">
    <h3 style="margin-top: 0; color: #fff;">‚ÑπÔ∏è What am I looking at?</h3>
    <p><strong>Active chain:</strong> The main blockchain everyone agrees on.</p>
    <p><strong>Valid forks (branch length 1):</strong> Orphaned blocks that arrived slightly late. This is
        <strong>completely normal</strong> in a fast blockchain (20s blocks). Miners occasionally find blocks at nearly
        the same time, and one gets orphaned.
    </p>
    <p><strong>Valid forks (branch length 2+):</strong> Deeper reorganizations. These are rarer and worth investigating.
    </p>
    <p style="margin-bottom: 0;"><em>Seeing many length-1 forks is healthy and expected.</em></p>
</div>

{% set active_tip = tips | selectattr('status', 'equalto', 'active') | list | first %}
{% set deep_forks = tips | rejectattr('status', 'equalto', 'active') | selectattr('branchlen', 'gt', 1) | list %}
{% set shallow_forks = tips | rejectattr('status', 'equalto', 'active') | selectattr('branchlen', 'equalto', 1) | list
%}

<div class="grid" style="margin-bottom: 1.5rem;">
    <div class="card">
        <h2>Active Chain</h2>
        <p class="muted">Height</p>
        <p class="value">{{ active_tip.height if active_tip else 'N/A' }}</p>
    </div>
    <div class="card">
        <h2>Deep Forks</h2>
        <p class="muted">2+ blocks</p>
        <p class="value">{{ deep_forks | length }}</p>
    </div>
    <div class="card">
        <h2>Orphaned Blocks</h2>
        <p class="muted">Single-block orphans</p>
        <p class="value">{{ shallow_forks | length }}</p>
        <p class="muted" style="font-size: 0.85em; margin-top: 0.5rem;">‚úì Expected behavior</p>
    </div>
</div>

<h2 style="margin-top: 2rem;">Active Chain & Deep Forks</h2>
<div class="table-scroll">
    <table>
        <thead>
            <tr>
                <th>Height</th>
                <th>Hash</th>
                <th>Status</th>
                <th>Branch Length</th>
            </tr>
        </thead>
        <tbody>
            {% if active_tip %}
            <tr>
                <td><a href="{{ url_for('block_by_height', height=active_tip.height) }}">{{ active_tip.height }}</a>
                </td>
                <td class="hash"><a href="{{ url_for('block_detail', block_hash=active_tip.hash) }}">{{ active_tip.hash
                        }}</a></td>
                <td><span class="tag success">Active</span></td>
                <td>{{ active_tip.branchlen }}</td>
            </tr>
            {% endif %}
            {% for tip in deep_forks %}
            <tr>
                <td><a href="{{ url_for('block_by_height', height=tip.height) }}">{{ tip.height }}</a></td>
                <td class="hash"><a href="{{ url_for('block_detail', block_hash=tip.hash) }}">{{ tip.hash }}</a></td>
                <td><span class="tag warning">{{ tip.status }}</span></td>
                <td><strong>{{ tip.branchlen }}</strong></td>
            </tr>
            {% endfor %}
            {% if not deep_forks %}
            <tr>
                <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                    No deep forks detected. The chain is running smoothly! üéâ
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<style>
    .tag {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: bold;
    }

    .tag.success {
        background: #4caf50;
        color: white;
    }

    .tag.warning {
        background: #ff9800;
        color: white;
    }
</style>
{% endblock %}